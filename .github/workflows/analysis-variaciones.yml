name: Analisis variaciones felinos

on:
  schedule:
    - cron: "15 8 * * *"  # 08:15 UTC diario; un guardia interno lo limita a cada 28 dias
  workflow_dispatch: {}

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service_account.json
    steps:
      - name: "Descargar repositorio"
        uses: actions/checkout@v4

      - name: "Configurar Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: "Instalar dependencias"
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            python -m pip install pandas numpy gspread google-auth
          fi

      - name: "Configurar credenciales de Google"
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON || '' }}
        if: ${{ env.GOOGLE_SERVICE_ACCOUNT_JSON != '' }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > "$GOOGLE_APPLICATION_CREDENTIALS"

      - name: "Verificar ventana de 28 dias"
        id: schedule_guard
        env:
          ANCHOR_TIMESTAMP_UTC: "2025-12-28T08:15:00+00:00"
        run: |
          python pipeline/schedule_guard.py

      - name: "Ejecucion diferida"
        if: ${{ steps.schedule_guard.outputs.should_run != 'true' }}
        run: |
          echo "El pipeline solo se ejecuta cada 28 dias desde 2025-12-28; hoy se omite."

      - name: "Ejecutar pipeline de analisis"
        id: run_pipeline
        if: ${{ steps.schedule_guard.outputs.should_run == 'true' }}
        env:
          SEO_SPREADSHEET_NAME: ${{ secrets.SEO_SPREADSHEET_NAME || '' }}
        run: |
          set -o pipefail
          SUMMARY_FILE=pipeline_summary.log  # almacenamos la salida para resumirla en Telegram
          : > "$SUMMARY_FILE"

          if [ -n "${SEO_SPREADSHEET_NAME}" ]; then
            echo "Lanzando pipeline con la hoja especificada: ${SEO_SPREADSHEET_NAME}" | tee -a "$SUMMARY_FILE"
            CMD=(python -u pipeline/analysis_variaciones.py --spreadsheet-name "${SEO_SPREADSHEET_NAME}" --verbose)
          else
            echo "Lanzando pipeline con el valor por defecto: SEO_Master_Data" | tee -a "$SUMMARY_FILE"
            CMD=(python -u pipeline/analysis_variaciones.py --verbose)
          fi

          "${CMD[@]}" 2>&1 | tee -a "$SUMMARY_FILE"
          PIPE_EXIT=${PIPESTATUS[0]}

          VARIATION_COUNT=$(grep -E "Total de URLs analizadas:" "$SUMMARY_FILE" | tail -n1 | awk -F': ' '{print $2}' | tr -d '[:space:]')
          EXECUTED_AT=$(TZ='America/Bogota' date '+%Y-%m-%d %H:%M:%S %Z')

          echo "variation_count=${VARIATION_COUNT:-0}" >> "$GITHUB_OUTPUT"
          echo "executed_at=${EXECUTED_AT}" >> "$GITHUB_OUTPUT"

          exit "$PIPE_EXIT"

      - name: "Notificar por Telegram"
        if: ${{ always() && steps.schedule_guard.outputs.should_run == 'true' }}
        env:
          JOB_STATUS: ${{ job.status }}
          SUMMARY_FILE: pipeline_summary.log
          VARIATION_COUNT: ${{ steps.run_pipeline.outputs.variation_count }}
          EXECUTED_AT: ${{ steps.run_pipeline.outputs.executed_at }}
        run: |
          TELEGRAM_BOT_TOKEN='${{ secrets.TELEGRAM_BOT_TOKEN }}'
          TELEGRAM_CHAT_ID='${{ secrets.TELEGRAM_CHAT_ID }}'
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram no configurado; se omite la notificaci√≥n."
            exit 0
          fi
          export TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID
          python pipeline/telegram_notifier.py
